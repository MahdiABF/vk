name: Android Build22

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install system deps
      run: |
        sudo apt-get update
        sudo apt-get install -y zip unzip openjdk-17-jdk libffi-dev libssl-dev automake autoconf \
          libtool pkg-config python3-dev cmake

    - name: Install buildozer & p4a
      run: |
        pip install --upgrade pip
        pip install buildozer python-for-android

    - name: Prepare Android SDK
      run: |
        mkdir -p "$HOME/android-sdk"
        yes | sdkmanager --sdk_root=$HOME/android-sdk "platforms;android-33" "platform-tools" "build-tools;33.0.2" "cmdline-tools;latest" "emulator"

    - name: Patch python-for-android build.py
      run: |
        P4A_BUILD=$(python -c "import pythonforandroid,os;print(os.path.dirname(pythonforandroid.__file__))")
        FILE="$P4A_BUILD/build.py"
        echo "Patching $FILE ..."
        sed -i 's/avdmanager(\x27list\x27, \x27target\x27).stdout.decode(\x27utf-8\x27).split(\x27\\n\x27)/str(avdmanager("list","target")).split("\\n")/' "$FILE"

    - name: Build with Buildozer
      run: |
        buildozer -v android debug
